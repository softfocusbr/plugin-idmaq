"use strict";class IdMaqPluginController{constructor(){this.token="",this.nomeIntegrador="",this.nomeUsuarioLogado="",this.tema="",this.posicaoTooltip="",this.idmaqPinCode="",this.idmaqPlugin=null,this.hashCode="",this.popup=null,this.idPluginRequest=null,this.urlBackoffice="http://127.0.0.1:8000/"}init(){document.createElement("IDMAQ-PLUGIN"),this.idmaqPlugin=document.getElementsByTagName("idmaq-plugin")[0],this.createGlobalFunction(),this.idmaqPlugin&&this.getAttributes()}createGlobalFunction(){window.IdmaqPlugin={getIdmaqPinCode:()=>this.idmaqPinCode}}getAttributes(){this.token=this.idmaqPlugin.getAttribute("token"),this.nomeIntegrador=this.idmaqPlugin.getAttribute("nome-integrador"),this.nomeUsuarioLogado=this.idmaqPlugin.getAttribute("nome-usuario-logado"),this.tema=this.idmaqPlugin.getAttribute("tema"),this.posicaoTooltip=this.idmaqPlugin.getAttribute("posicao-tooltip"),this.token?this.checkImage(`${this.urlBackoffice}static/images/botao-idmaq.png?v=${(new Date).getTime()}`):console.warn("Você precisa informar um atributo token para o elemento <idmaq-plugin> para que o plugin do Idmaq funcione corretamente.")}checkImage(e){var t=new Image;t.onload=(()=>{this.createElements(e)}),t.onerror=(()=>{console.warn("Serviço temporariamente indisponível. Entre em contato com o suporte técnico.")}),t.src=e}createElements(e){const t=this.createImg(e),o=this.createButton(),i=this.createTooltip();this.idmaqPlugin.appendChild(o),o.appendChild(t),this.idmaqPlugin.appendChild(i)}createImg(e){const t=document.createElement("IMG");return t.classList.add("idmaq-image"),t.src=e,t}createButton(){const e=document.createElement("BUTTON");return e.classList.add("idmaq-button"),e.onclick=(()=>this.getHashCode()),e}createTooltip(){const e=document.createElement("DIV");return e.classList.add("idmaq-tooltip"),this.posicaoTooltip&&e.classList.add(this.posicaoTooltip),e.innerText="Uma forma rápida e segura de criar a identidade de seu maquinário agrícola. Tenha acesso a melhores taxas de seguro, financiamento e condições para revenda do seu equipamento.",e}async getHashCode(){this.idPluginRequest=null;const e=new Headers({Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${this.token}`}),t=await fetch(`${this.urlBackoffice}api/plugin-request/`,{method:"POST",headers:e,body:JSON.stringify({nome_usuario_logado:this.nomeUsuarioLogado,nome_integrador:this.nomeIntegrador})}).catch(()=>{this.mostrarMensagemErroServidor()});if(200===t.status){const e=await t.json();this.hashCode=e.hashcode,this.idPluginRequest=e.id,this.abrirPopup()}else{const e=await t.json();console.error(e),this.mostrarMensagemErroServidor()}}abrirPopup(){this.idmaqPinCode="";let e=`scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=750,height=600,left=${screen.width/2-375},top=${screen.height/2-300}`;this.popup=window.open(`${this.urlBackoffice}cadastros/plugin/${encodeURIComponent(this.hashCode)}?tema=${this.tema}`,"IDMAQ",e),this.popup?this.verificaPopupFechado():window.alert("É preciso desabilitar o bloqueio de popup para esta página, nas configurações do seu navegador.")}verificaPopupFechado(){const e=setInterval(()=>{this.popup.closed&&(this.recuperarPinCode(),clearInterval(e))},100)}async recuperarPinCode(){const e=new Headers({Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${this.token}`}),t=await fetch(`${this.urlBackoffice}api/plugin-request/${this.idPluginRequest}/`,{method:"GET",headers:e}).catch(()=>{this.mostrarMensagemErroServidor()}),o=await t.json();this.setaValorPinCode(o.idmaq_pincode)}setaValorPinCode(e){this.idmaqPinCode=e,console.log(`Máquina cadastrada com sucesso. Seu Idmaq pincode é: ${window.IdmaqPlugin.getIdmaqPinCode()}`)}mostrarMensagemErroServidor(){alert("Houve um problema de comunicação com o servidor. Por favor, entre em contato com o suporte")}}window.addEventListener("load",()=>{(new IdMaqPluginController).init()});